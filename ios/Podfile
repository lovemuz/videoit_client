# --- Fix broken Boost URL for React Native ---
boost_spec_path = File.join(__dir__, '../node_modules/react-native/third-party-podspecs/boost.podspec')

if File.exist?(boost_spec_path)
  content = File.read(boost_spec_path)
  
  # Replace broken GitHub URL with permanent Boost archive mirror
  content.gsub!(
    %r{https://github.com/boostorg/boost/releases/download/boost-1\.76\.0/boost-1\.76\.0\.tar\.gz},
    'https://archives.boost.io/release/1.76.0/source/boost_1_76_0.tar.gz'
  )

  File.write(boost_spec_path, content)
  Pod::UI.puts "ğŸ”§ Boost URL patched successfully."
else
  Pod::UI.puts "âš ï¸ Boost podspec not found. Skipping patch."
end
# --- End Fix ---


require 'pathname'

require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

platform :ios, '13.4'
prepare_react_native_project!

# ğŸš« Flipper ì™„ì „ ë¹„í™œì„±í™” (Archive ì¶©ëŒ ë°©ì§€)
flipper_config = FlipperConfiguration.disabled

linkage = ENV['USE_FRAMEWORKS']
if linkage != nil
  Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
  use_frameworks! :linkage => linkage.to_sym
end

target 'nmoment' do
  config = use_native_modules!

  # âœ… Permissions ê´€ë ¨
  permissions_path = '../node_modules/react-native-permissions/ios'
  pod 'Permission-PhotoLibrary', :path => "#{permissions_path}/PhotoLibrary"
  pod 'Permission-Microphone', :path => "#{permissions_path}/Microphone"
  pod 'Permission-AppTrackingTransparency', :path => "#{permissions_path}/AppTrackingTransparency"

  # âœ… ê¸°íƒ€ ìˆ˜ë™ ì—°ê²° ë¼ì´ë¸ŒëŸ¬ë¦¬
  pod 'RNIap', :path => '../node_modules/react-native-iap'
  pod 'FirebaseCore', :modular_headers => true
  pod 'GoogleUtilities', :modular_headers => true
  pod 'ReactNativeIncallManager', :path => '../node_modules/react-native-incall-manager'
  pod 'RNFS', :path => '../node_modules/react-native-fs'
  pod 'react-native-in-app-review', :path => '../node_modules/react-native-in-app-review'
  pod 'RNCallKeep', :path => '../node_modules/react-native-callkeep'
  pod 'RNInAppBrowser', :path => '../node_modules/react-native-inappbrowser-reborn'
  pod 'react-native-fbsdk-next', :path => '../node_modules/react-native-fbsdk-next'
  pod 'react-native-appsflyer', :path => '../node_modules/react-native-appsflyer'

  flags = get_default_flags()

  # âœ… React Native ê¸°ë³¸ ì„¤ì • (Hermes í¬í•¨)
  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => flags[:hermes_enabled],
    :fabric_enabled => flags[:fabric_enabled],
    :flipper_configuration => flipper_config,
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  target 'nmomentTests' do
    inherit! :complete
  end

  post_install do |installer|
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )

    # âœ… ëª¨ë“  íƒ€ê²Ÿì˜ iOS ë°°í¬ ë²„ì „ í†µì¼ + bitcode ë¹„í™œì„±í™”
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.4'
        config.build_settings['ENABLE_BITCODE'] = 'NO'
        config.build_settings['BITCODE_GENERATION_MODE'] = 'marker'
      end
    end

    # âœ… Folly Time.h ì¶©ëŒ íŒ¨ì¹˜
    system("find Pods/RCT-Folly/folly/portability -name 'Time.h' -exec sed -i '' 's/^typedef uint8_t clockid_t;/#ifndef __APPLE__\\ntypedef uint8_t clockid_t;\\n#endif/' {} +")

    # âœ… Flipper ê´€ë ¨ ë¹Œë“œ ë¹„í™œì„±í™”
    installer.pods_project.targets.each do |target|
      if target.name.include?('Flipper')
        target.build_configurations.each do |config|
          config.build_settings['EXCLUDED_SOURCE_FILE_NAMES'] = 'Flipper*'
        end
      end
    end

    # âœ… Hermes bitcode ì œê±° + ì½”ë“œ ì„œëª… ì¬ì ìš© (App Store ì˜¤ë¥˜ ë°©ì§€)
    hermes_bin = "Pods/hermes-engine/destroot/Library/Frameworks/hermes.framework/hermes"
    hermes_framework = "Pods/hermes-engine/destroot/Library/Frameworks/hermes.framework"
    if File.exist?(hermes_bin)
      system("xcrun bitcode_strip #{hermes_bin} -r -o #{hermes_bin}")
      system("codesign --force --sign - #{hermes_bin}")
      system("codesign --force --sign - --deep #{hermes_framework}")
      Pod::UI.puts "âœ… Hermes bitcode removed and re-signed"
    else
      Pod::UI.warn "âš ï¸ Hermes binary not found at #{hermes_bin}"
    end
  end
end
